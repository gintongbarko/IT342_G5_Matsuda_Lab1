sequenceDiagram
    participant User as User (Web/Mobile)
    participant UI as Protected UI
    participant UserCtrl as UserController
    participant AuthSvc as AuthService
    participant TSCtrl as TimesheetController
    participant TSSvc as TimesheetService
    participant UserRepo as UserRepository
    participant EmpRepo as EmployeeRepository
    participant TSRepo as TimesheetRecordRepository
    participant JWT as JwtUtil
    participant DB as MySQL

    User->>UI: Open app/dashboard
    UI->>UserCtrl: GET /api/user/me (Bearer token)
    UserCtrl->>AuthSvc: getCurrentUser(token)
    AuthSvc->>JWT: validateToken + getUserIdFromToken
    AuthSvc->>UserRepo: findById(userId)
    UserRepo->>DB: SELECT users
    DB-->>UserRepo: user row
    UserRepo-->>AuthSvc: User
    AuthSvc-->>UserCtrl: UserResponse{role, employerName}
    UserCtrl-->>UI: 200 OK

    UI->>TSCtrl: GET /api/timesheets/dashboard (Bearer token)
    TSCtrl->>TSSvc: getDashboard(authenticatedUserId)

    alt role = EMPLOYER
        TSSvc->>EmpRepo: findByCreatedByUser_UserIdAndIsActiveTrueOrderByEmployeeNameAsc
        EmpRepo->>DB: SELECT employees list
        TSSvc->>TSRepo: findByCreatedByUser_UserIdOrderByClockInAtDesc
        TSRepo->>DB: SELECT employee logs
        DB-->>TSSvc: employees + records
        TSSvc-->>TSCtrl: dashboard(employees,records,clockedIn=false)
    else role = EMPLOYEE
        TSSvc->>EmpRepo: findTopByEmployeeNameAndCreatedByUser_UserIdOrderByEmployeeIdDesc
        EmpRepo->>DB: SELECT employee row
        TSSvc->>TSRepo: findByEmployee_EmployeeIdOrderByClockInAtDesc
        TSRepo->>DB: SELECT own records
        TSSvc->>TSRepo: findFirstByEmployee_EmployeeIdAndStatusOrderByClockInAtDesc(...,"clocked_in")
        TSRepo->>DB: SELECT active record
        DB-->>TSSvc: records + active flag
        TSSvc-->>TSCtrl: dashboard(employerName,accumulatedHours,clockedIn,records)
    end

    TSCtrl-->>UI: 200 OK TimesheetDashboardResponse
    UI-->>User: Render role-based dashboard view
