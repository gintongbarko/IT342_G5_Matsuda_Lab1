sequenceDiagram
    participant User as User (Web/Mobile)
    participant UI as Login Screen/Page
    participant AuthCtrl as AuthController
    participant AuthSvc as AuthService
    participant UserRepo as UserRepository
    participant SessRepo as UserSessionRepository
    participant JWT as JwtUtil
    participant DB as MySQL

    User->>UI: Enter username/email + password
    UI->>AuthCtrl: POST /api/auth/login
    AuthCtrl->>AuthSvc: login(request)

    AuthSvc->>UserRepo: findByUsernameOrEmail(input,input)
    UserRepo->>DB: SELECT users
    DB-->>UserRepo: user/null

    alt User not found
        AuthSvc-->>AuthCtrl: RuntimeException("Invalid credentials")
        AuthCtrl-->>UI: 401 Unauthorized
    else User found
        alt isActive=false
            AuthSvc-->>AuthCtrl: RuntimeException("Account is disabled")
            AuthCtrl-->>UI: 403 Forbidden
        else Active user
            AuthSvc->>AuthSvc: verify password
            alt Wrong password
                AuthSvc->>UserRepo: save(failedAttempts + 1)
                UserRepo->>DB: UPDATE users.failed_attempts
                alt failedAttempts >= 5
                    AuthSvc->>UserRepo: save(is_active=false)
                    UserRepo->>DB: UPDATE users.is_active
                    AuthSvc-->>AuthCtrl: RuntimeException("Account locked")
                    AuthCtrl-->>UI: 403 Forbidden
                else attempts < 5
                    AuthSvc-->>AuthCtrl: RuntimeException("Invalid credentials")
                    AuthCtrl-->>UI: 401 Unauthorized
                end
            else Password correct
                AuthSvc->>UserRepo: save(reset attempts + lastLogin)
                UserRepo->>DB: UPDATE users

                AuthSvc->>SessRepo: findByUser_UserIdAndIsActiveTrue(userId)
                SessRepo->>DB: SELECT active sessions
                DB-->>SessRepo: active sessions
                AuthSvc->>SessRepo: saveAll(set is_active=false)
                SessRepo->>DB: UPDATE old sessions inactive

                AuthSvc->>JWT: generateToken(userId)
                JWT-->>AuthSvc: token
                AuthSvc->>SessRepo: save(new UserSession)
                SessRepo->>DB: INSERT user_sessions

                AuthSvc-->>AuthCtrl: AuthResponse(token,user{role,employerName})
                AuthCtrl-->>UI: 200 OK
                UI-->>User: Store token and open dashboard
            end
        end
    end
