sequenceDiagram
    participant User as Employee User (Web/Mobile)
    participant UI as Timesheet UI
    participant TSCtrl as TimesheetController
    participant TSSvc as TimesheetService
    participant EmpRepo as EmployeeRepository
    participant TSRepo as TimesheetRecordRepository
    participant DB as MySQL

    User->>UI: Press Clock Out
    UI->>TSCtrl: POST /api/timesheets/clock-out (Bearer token)
    TSCtrl->>TSSvc: clockOut(authenticatedUserId)

    TSSvc->>EmpRepo: findTopByEmployeeNameAndCreatedByUser_UserId...
    EmpRepo->>DB: SELECT employee row
    DB-->>EmpRepo: employee

    TSSvc->>TSRepo: findFirstByEmployee_EmployeeIdAndStatus(..., "clocked_in")
    TSRepo->>DB: SELECT active record
    DB-->>TSRepo: active/null

    alt No active clock-in record
        TSSvc-->>TSCtrl: RuntimeException("No active clock-in record found")
        TSCtrl-->>UI: 400 Bad Request
    else Active record found
        TSSvc->>TSSvc: Compute hoursWorked from now - clockInAt
        TSSvc->>TSRepo: save(updated record status=clocked_out)
        TSRepo->>DB: UPDATE timesheet_records
        DB-->>TSRepo: saved
        TSSvc-->>TSCtrl: success
        TSCtrl-->>UI: 200 OK
        UI-->>User: Refresh dashboard and accumulated hours
    end
