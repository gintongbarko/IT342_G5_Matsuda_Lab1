sequenceDiagram
    participant User as User (Web/Mobile)
    participant UI as Register Screen/Page
    participant AuthCtrl as AuthController
    participant AuthSvc as AuthService
    participant UserRepo as UserRepository
    participant EmpRepo as EmployeeRepository
    participant SessRepo as UserSessionRepository
    participant JWT as JwtUtil
    participant DB as MySQL

    User->>UI: Choose role + enter username/email/password
    alt Role = EMPLOYEE
        UI->>AuthCtrl: GET /api/auth/employers/search?q=<text>
        AuthCtrl->>AuthSvc: searchEmployers(query)
        AuthSvc->>UserRepo: findTop10ByRoleAndUsernameContainingIgnoreCase...
        UserRepo->>DB: SELECT employers
        DB-->>UserRepo: Employer list
        UserRepo-->>AuthSvc: List<User>
        AuthSvc-->>AuthCtrl: List<UserResponse>
        AuthCtrl-->>UI: 200 OK
        User->>UI: Select employer
    end

    UI->>AuthCtrl: POST /api/auth/register {username,email,password,role,employerUsername?}
    AuthCtrl->>AuthSvc: register(request)

    AuthSvc->>UserRepo: existsByUsername / existsByEmail
    UserRepo->>DB: SELECT checks
    DB-->>UserRepo: results

    alt Duplicate username/email
        AuthSvc-->>AuthCtrl: RuntimeException("User already exists" or "Email already exists")
        AuthCtrl-->>UI: 409 Conflict
    else Valid user
        alt Role = EMPLOYEE
            AuthSvc->>UserRepo: findByUsernameIgnoreCase(employerUsername)
            UserRepo->>DB: SELECT employer user
            DB-->>UserRepo: employer record
        end

        AuthSvc->>UserRepo: save(User)
        UserRepo->>DB: INSERT users
        DB-->>UserRepo: persisted user

        alt Role = EMPLOYEE
            AuthSvc->>EmpRepo: save(Employee)
            EmpRepo->>DB: INSERT employees (employee_name, created_by_user_id)
            DB-->>EmpRepo: persisted employee
        end

        AuthSvc->>SessRepo: findByUser_UserIdAndIsActiveTrue(userId)
        SessRepo->>DB: SELECT active sessions
        DB-->>SessRepo: active sessions
        AuthSvc->>SessRepo: saveAll(set is_active=false)
        SessRepo->>DB: UPDATE old sessions inactive

        AuthSvc->>JWT: generateToken(userId)
        JWT-->>AuthSvc: token
        AuthSvc->>SessRepo: save(new UserSession)
        SessRepo->>DB: INSERT user_sessions
        DB-->>SessRepo: saved

        AuthSvc-->>AuthCtrl: AuthResponse(token,user{role,employerName})
        AuthCtrl-->>UI: 201 Created
        UI-->>User: Navigate to dashboard
    end
